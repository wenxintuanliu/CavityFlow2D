## 1. 网格与变量存储（MAC 交错网格）

计算域 $[0,1]\times[0,1]$，均匀剖分为 $nx\times ny$：

- $\Delta x = 1/nx$，$\Delta y = 1/ny$
- $p\in\mathbb{R}^{ny\times nx}$：单元中心
- $u\in\mathbb{R}^{ny\times (nx+1)}$：垂直面（左右面）
- $v\in\mathbb{R}^{(ny+1)\times nx}$：水平面（上下边）



边界条件：

- 顶盖：$u=1$，$v=0$
- 其余三壁：$u=v=0$

---

## 2. 时间步长检查（与代码一致的稳定性估计）

求解器在开始时输出一个保守的 dt 建议值：

- CFL 限制（顶盖速度估计 $u_{max}=1$）：
    $$\Delta t_{cfl}=\min(\Delta x,\Delta y)/u_{max}$$
- 扩散限制（显式格式的经验上界）：
    $$\Delta t_{diff}=0.25\,Re\,\min(\Delta x,\Delta y)^2$$

并取：
$$\Delta t_{rec}=\min(\Delta t_{cfl},\Delta t_{diff})$$

实际输入$\Delta t$应该小于上述建议值。

---

## 3. 每步迭代框架（投影法）

对每个时间步 $n=0,1,\dots$：

1) 预测步：由动量方程（不含压力梯度）得到 $u^*,v^*$

2) 压力步：由连续性条件构造压力泊松方程（PPE），迭代求 $p$

3) 校正步：用压力梯度修正速度，得到 $u^{n+1},v^{n+1}$

---

## 4. 预测步：动量方程离散（得到 $u^*, v^*$）

### 4.1 Ghost Cell 处理（实现方式）

代码通过 padding + 手动赋值实现边界外推：

- 对 $u$ 在上下各加一层（`un_pad = pad(un, ((1,1),(0,0)))`）
    - 下壁无滑移：`un_pad[0,:] = -un[0,:]`
    - 顶盖 Dirichlet：`un_pad[-1,:] = 2*u_top - un[-1,:]`
- 对 $v$ 在左右各加一层（`vn_pad = pad(vn, ((0,0),(1,1)))`）
    - 左右壁无滑移：`vn_pad[:,0] = -vn[:,0]`，`vn_pad[:,-1] = -vn[:,-1]`

### 4.2 扩散项（二阶中心差分）

对 $u$ 与 $v$ 都使用 $\nabla^2$ 的二阶中心差分离散。

### 4.3 对流项（MAC 的“平均 + 差分”通量形式）

代码按 MAC 思路构造通量导数：

- $u$ 方程：
    - $\partial(u^2)/\partial x$：由相邻面平均构造通量后做差分
    - $\partial(uv)/\partial y$：将 $v$ 插值到 $u$ 所在角点，再构造 $uv$ 通量
- $v$ 方程同理：
    - $\partial(v^2)/\partial y$
    - $\partial(uv)/\partial x$

### 4.4 显式更新与中间边界约束

显式欧拉更新得到 $u^*,v^*$ 后，代码立即强制中间速度边界：

- `u_star[:,0]=u_star[:,-1]=0`
- `v_star[0,:]=v_star[-1,:]=0`

---

## 5. 压力泊松方程（PPE）

### 5.1 源项 $b$（散度/时间步）

由 $u^*,v^*$ 计算散度：

$$
\nabla\cdot\mathbf{u}^*\approx \frac{u^*_{j,i+1/2}-u^*_{j,i-1/2}}{\Delta x}+\frac{v^*_{j+1/2,i}-v^*_{j-1/2,i}}{\Delta y}
$$

并取：
$$b = \frac{1}{\Delta t}\,\nabla\cdot\mathbf{u}^*$$

对应实现：`div_u_star = ...`，`b = div_u_star / dt`。

### 5.2 边界条件（Neumann：$\partial p/\partial n=0$）

压力采用 `p_pad = pad(p, ((1,1),(1,1)))`，并在每次迭代里对 Ghost Cell 施加：

- Bottom：`p_pad[0,1:-1]=p_pad[1,1:-1]`
- Top：`p_pad[-1,1:-1]=p_pad[-2,1:-1]`
- Left：`p_pad[1:-1,0]=p_pad[1:-1,1]`
- Right：`p_pad[1:-1,-1]=p_pad[1:-1,-2]`

### 5.3 离散格式

内部点更新公式（与代码系数一致）：

$$
p_{i,j}=\frac{\Delta y^2(p_{i,j+1}+p_{i,j-1})+\Delta x^2(p_{i+1,j}+p_{i-1,j})-\Delta x^2\Delta y^2 b_{i,j}}{2(\Delta x^2+\Delta y^2)}
$$

### 5.4 迭代方法与停止

最大迭代 `max_ppe_iter=2000`。

- Jacobi：全域同步更新。
- Gauss-Seidel / SOR：红黑（mask_red/mask_black）交替更新；
    - GS 相当于 $\omega=1.0$
    - SOR 使用用户给定 $\omega$（代码变量 `current_omega`）

收敛判据：每 10 次迭代检查一次
$$\max|p^{k+1}-p^k|<Ptol$$

压力求解后会做归一化：`p -= mean(p)`（消除压力常数漂移）。

---

## 6. 校正步：速度修正（Projection）

得到 $p$ 后，用压力梯度修正速度：

- `u[:,1:-1] = u_star[:,1:-1] - dt*(p[:,1:]-p[:,:-1])/dx`
- `v[1:-1,:] = v_star[1:-1,:] - dt*(p[1:,:]-p[:-1,:])/dy`

随后再次强制边界，并恢复顶盖速度：

- `u[:,0]=u[:,-1]=0`
- `v[0,:]=v[-1,:]=0`
- `u[-1,:]=u_top`

---

## 7. 收敛判据、快照保存与停止

### 7.1 速度收敛判据（每 100 步检查一次）

代码每 100 步计算相对误差：

$$
err_u=\frac{\|u^{n+1}-u^n\|_2}{\|u^n\|_2+10^{-12}},\qquad
err_v=\frac{\|v^{n+1}-v^n\|_2}{\|v^n\|_2+10^{-12}}
$$

当 $err_u<Vtol$ 且 $err_v<Vtol$，认为收敛并停止。

### 7.2 快照保存（save_interval）

- `save_interval=None`：仅在结束时保存最后一帧（最省内存）。
- `save_interval=N`：每 N 步保存一次，但不保存第 0 步；结束时保证保存最后一帧，并避免与间隔快照重复。

### 7.3 停止计算（仅 Streamlit 环境）

若在 Streamlit 中运行，求解器内部每 50 步检查一次 `st.session_state["cfd_cancel_requested"]`，为 True 时提前停止并返回停止步数信息（若启用 `return_info=True`）。

---

## 8. 输出

返回值：

- `u_list, v_list, p_list`：保存的快照序列（或仅最后一帧）
- 当 `return_info=True`：额外返回 `info`（是否收敛、收敛步数、是否被停止等）
